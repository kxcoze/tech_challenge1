# Техническое задание кандитата Лощёва Захара
## Содержание
- [Постановка задачи](#постановка-задачи)
- [Инструкция по запуску](#инструкция-по-запуску)
- [Клонирование репозитория и настройка конфигов](#клонирование-репозитория-и-настройка-конфигов)
- [Проверка работоспособности сервиса](#проверка-работоспособности-сервиса)
- [Замечания](#замечания)

---

## Постановка задачи
1. С помощью Docker (предпочтительно - docker-compose) развернуть образ с любой опенсорсной СУБД (предпочтительно - PostgreSQL). Предоставить все необходимые скрипты и конфигурационные (docker/compose) файлы для развертывания СУБД, а также инструкции для подключения к ней. Необходимо обеспечить сохранность данных при рестарте контейнера (то есть - использовать volume-ы для хранения файлов СУБД на хост-машине.
2. Реализовать на Python3 простой веб сервис (с помощью FastAPI или Flask, например), выполняющий следующие функции:В сервисе должно быть реализовано REST API, принимающее на вход POST запросы с содержимым вида {"questions_num": integer}; После получения запроса сервис, в свою очередь, запрашивает с публичного API (англоязычные вопросы для викторин) https://jservice.io/api/random?count=1 указанное в полученном запросе количество вопросов.
Далее, полученные ответы должны сохраняться в базе данных из п. 1, причем сохранена должна быть как минимум следующая информация (название колонок и типы данный можете выбрать сами, также можете добавлять свои колонки): 1. ID вопроса, 2. Текст вопроса, 3. Текст ответа, 4. - Дата создания вопроса. В случае, если в БД имеется такой же вопрос, к публичному API с викторинами должны выполняться дополнительные запросы до тех пор, пока не будет получен уникальный вопрос для викторины.
Ответом на запрос из п.2.a должен быть предыдущей сохранённый вопрос для викторины. В случае его отсутствия - пустой объект.

3. В репозитории с заданием должны быть предоставлены инструкции по сборке докер-образа с сервисом из п. 2., его настройке и запуску. А также пример запроса к POST API сервиса.

4. Желательно, если при выполнении задания вы будете использовать docker-compose, SqlAalchemy,  пользоваться аннотацией типов.


## Инструкция по запуску
### Клонирование репозитория и настройка конфигов
1. Склонировать данный репозиторий 
```git
git clone https://github.com/kxcoze/tech_challenge1
```
2. Перейти в директорию `tech_challenge1`
```bash
cd tech_challenge1/
```
3. Создать файл `.env` из `env_dist`
```bash
cp env_dist .env
```
4. Изменить содержимое файла `.env`
```bash
nano .env
```
Содержимое конфига .env
| Переменная | Описание | Вид |
| ---------- | -------- | --- |
| `POSTGRES_USER` | Имя пользователя для базы данных в контейнере `db` | любая строка, например: `admin` |
| `POSTGRES_PASSWORD` | Пароль для аутентификации пользователя в контейнере `db` | любая строка, например: `adm1n8765` |
| `POSTGRES_DB` | Имя базы данных в контейнере `db` | любая строка, например: `db`|
| `MAX_ATTEMPTS` | Максимальное кол-во попыток получения хотя бы одного нового вопроса с адреса `https://jservice.io/api/random?count=1`| по умолчанию `10` |
### Запуск docker-compose
1. Запуск docker-compose с помощью команды
```bash
docker-compose up -d --build
```

## Проверка работоспособности сервиса
Чтобы проверить работу сервиса необходимо отправить на адрес `http://localhost:8000/get_questions/` `POST` запрос с телом вида
```json
{
    questions_num: 1
}
```
1. Отправка с помощью `httpie`
```bash
http POST http://localhost:8000/get_questions/ questions_num=1
```
2. Отправка с помощью `curl`
```bash
curl -X 'POST' \
  'http://localhost:8000/get_questions/' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "questions_num": 1
}'
```
3. Отправка с помощью модуля `requests`
```py
import requests

url = "http://localhost:8000/get_questions/"
data = {"questions_num": 1}
response = requests.post(url, json=data)

print(response.json())
```

4. Ответ сервера примерно будет таков:
```http
HTTP/1.1 200 OK
content-length: 440
content-type: application/json
date: Thu, 12 Oct 2023 12:24:06 GMT
server: uvicorn

{
    "airdate": "1995-09-25T19:00:00.000Z",
    "answer": "Reagan",
    "category": {
        "clues_count": 309,
        "created_at": "2022-12-30T18:47:15.121Z",
        "id": 2237,
        "title": "annual events",
        "updated_at": "2022-12-30T18:47:15.121Z"
    },
    "category_id": 2237,
    "created_at": "2022-12-30T18:56:04.703Z",
    "game_id": 2726,
    "id": 44089,
    "invalid_count": null,
    "question": "In 1985 this president proclaimed August 26 as Women's Equality Day",
    "updated_at": "2022-12-30T18:56:04.703Z",
    "value": 200
}

```

## Замечания
* В данном репозитории используются следующие технологии: `Docker`, `docker-compose`, `PostgreSQL`, `FastAPI`, `SQLAlchemy`.
* Для обеспечения сохранности данных при рестарте контейнера, используется монтирование volume-а для хранения файлов СУБД.
* Для выполнения запросов к публичному API с вопросами используется библиотека `aiohttp`.

